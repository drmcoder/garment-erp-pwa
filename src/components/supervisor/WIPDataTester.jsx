import React, { useState } from 'react';
import { useLanguage } from '../../context/LanguageContext';
import { WIPDataParser, parseWIPData } from '../../utils/wipDataParser';

const WIPDataTester = () => {
  const { currentLanguage } = useLanguage();
  const [testResults, setTestResults] = useState([]);
  const [isRunning, setIsRunning] = useState(false);

  // Sample test data in different formats
  const testDataSets = {
    horizontal_matrix: [
      ['Color', 'XS', 'S', 'M', 'L', 'XL', '2XL', '3XL'],
      ['рдиреАрд▓реЛ-1', '45', '60', '80', '85', '70', '40', '25'],
      ['рд░рд╛рддреЛ-1', '40', '55', '75', '80', '65', '35', '20'],
      ['рд╕реЗрддреЛ-1', '35', '50', '70', '75', '60', '30', '15']
    ],
    
    vertical_matrix: [
      ['Size', 'рдиреАрд▓реЛ-1', 'рд░рд╛рддреЛ-1', 'рд╕реЗрддреЛ-1'],
      ['XS', '45', '40', '35'],
      ['S', '60', '55', '50'],
      ['M', '80', '75', '70'],
      ['L', '85', '80', '75'],
      ['XL', '70', '65', '60'],
      ['2XL', '40', '35', '30'],
      ['3XL', '25', '20', '15']
    ],
    
    detailed_breakdown: [
      ['Color', 'Size', 'Pieces', 'Lot', 'Article'],
      ['рдиреАрд▓реЛ-1', 'XS', '45', 'S-85', '8085'],
      ['рдиреАрд▓реЛ-1', 'S', '60', 'S-85', '8085'],
      ['рдиреАрд▓реЛ-1', 'M', '80', 'S-85', '8085'],
      ['рд░рд╛рддреЛ-1', 'XS', '40', 'S-85', '8085'],
      ['рд░рд╛рддреЛ-1', 'S', '55', 'S-85', '8085'],
      ['рд╕реЗрддреЛ-1', 'M', '70', 'S-85', '8085']
    ],
    
    cutting_layout: [
      ['Color', 'Size', 'Pieces', 'Layers', 'Fabric', 'Buyer'],
      ['рдиреАрд▓реЛ-1', 'L', '85', '4', 'Cotton Pique', 'ABC Garments'],
      ['рдиреАрд▓реЛ-1', 'XL', '70', '3', 'Cotton Pique', 'ABC Garments'],
      ['рд░рд╛рддреЛ-1', 'L', '80', '4', 'Cotton Pique', 'ABC Garments'],
      ['рд░рд╛рддреЛ-1', 'XL', '65', '3', 'Cotton Pique', 'ABC Garments']
    ],
    
    batch_summary: [
      ['Lot', 'Article', 'Color', 'Total_Pieces', 'Cutting_Date', 'Buyer'],
      ['S-85', '8085', 'рдиреАрд▓реЛ-1', '405', '2024-08-23', 'ABC Garments'],
      ['S-85', '8085', 'рд░рд╛рддреЛ-1', '370', '2024-08-23', 'ABC Garments'],
      ['S-86', '8086', 'рд╕реЗрддреЛ-1', '335', '2024-08-23', 'XYZ Fashion']
    ]
  };

  const runAllTests = async () => {
    setIsRunning(true);
    const results = [];

    for (const [formatName, testData] of Object.entries(testDataSets)) {
      try {
        console.log(`Testing format: ${formatName}`);
        
        const startTime = Date.now();
        const parsed = await parseWIPData(testData, 'auto');
        const endTime = Date.now();
        
        const parser = new WIPDataParser();
        const validation = parser.validateParsedData(parsed);
        const stats = parser.generateStats(parsed);
        
        results.push({
          format: formatName,
          success: true,
          detectedFormat: parsed.format,
          processingTime: endTime - startTime,
          stats: stats,
          validation: validation,
          data: parsed
        });
      } catch (error) {
        results.push({
          format: formatName,
          success: false,
          error: error.message
        });
      }
    }

    setTestResults(results);
    setIsRunning(false);
  };

  const getFormatDisplayName = (format) => {
    const names = {
      horizontal_matrix: currentLanguage === 'np' ? 'рд╣реЛрд░рд┐рдЬрдиреНрдЯрд▓ рдореНрдпрд╛рдЯреНрд░рд┐рдХреНрд╕' : 'Horizontal Matrix',
      vertical_matrix: currentLanguage === 'np' ? 'рднрд░реНрдЯрд┐рдХрд▓ рдореНрдпрд╛рдЯреНрд░рд┐рдХреНрд╕' : 'Vertical Matrix',
      detailed_breakdown: currentLanguage === 'np' ? 'рд╡рд┐рд╕реНрддреГрдд рдмреНрд░реЗрдХрдбрд╛рдЙрди' : 'Detailed Breakdown',
      cutting_layout: currentLanguage === 'np' ? 'рдХрдЯрд┐рдЩ рд▓реЗрдЖрдЙрдЯ' : 'Cutting Layout',
      batch_summary: currentLanguage === 'np' ? 'рдмреНрдпрд╛рдЪ рд╕рд╛рд░рд╛рдВрд╢' : 'Batch Summary'
    };
    return names[format] || format;
  };

  return (
    <div className="max-w-6xl mx-auto p-6">
      <div className="bg-white rounded-lg shadow-sm border">
        <div className="p-6 border-b">
          <h2 className="text-2xl font-bold text-gray-900">
            ЁЯзк {currentLanguage === 'np' ? 'WIP рдбреЗрдЯрд╛ рдкрд╛рд░реНрд╕рд░ рдкрд░реАрдХреНрд╖рдг' : 'WIP Data Parser Testing'}
          </h2>
          <p className="text-gray-600 mt-2">
            {currentLanguage === 'np' 
              ? 'рд╡рд┐рднрд┐рдиреНрди рдлрд░реНрдореНрдпрд╛рдЯрд╣рд░реВрдорд╛ WIP рдбреЗрдЯрд╛ рдкрд╛рд░реНрд╕рд┐рдЩ рдкрд░реАрдХреНрд╖рдг рдЧрд░реНрдиреБрд╣реЛрд╕реН'
              : 'Test WIP data parsing across different formats'
            }
          </p>
        </div>

        <div className="p-6">
          <button
            onClick={runAllTests}
            disabled={isRunning}
            className="bg-blue-600 text-white px-6 py-3 rounded-lg font-medium hover:bg-blue-700 disabled:opacity-50 mb-6"
          >
            {isRunning 
              ? (currentLanguage === 'np' ? 'тП│ рдкрд░реАрдХреНрд╖рдг рдЪрд▓рд┐рд░рд╣реЗрдХреЛ рдЫ...' : 'тП│ Running Tests...')
              : (currentLanguage === 'np' ? 'ЁЯЪА рд╕рдмреИ рдкрд░реАрдХреНрд╖рдгрд╣рд░реВ рдЪрд▓рд╛рдЙрдиреБрд╣реЛрд╕реН' : 'ЁЯЪА Run All Tests')
            }
          </button>

          {/* Test Results */}
          {testResults.length > 0 && (
            <div className="space-y-6">
              <h3 className="text-lg font-semibold text-gray-800">
                ЁЯУК {currentLanguage === 'np' ? 'рдкрд░реАрдХреНрд╖рдг рдкрд░рд┐рдгрд╛рдорд╣рд░реВ' : 'Test Results'}
              </h3>

              <div className="grid grid-cols-1 lg:grid-cols-2 gap-4">
                {testResults.map((result, index) => (
                  <div
                    key={index}
                    className={`border rounded-lg p-4 ${
                      result.success ? 'border-green-200 bg-green-50' : 'border-red-200 bg-red-50'
                    }`}
                  >
                    <div className="flex items-center justify-between mb-3">
                      <h4 className="font-semibold text-gray-900">
                        {getFormatDisplayName(result.format)}
                      </h4>
                      <span className={`px-2 py-1 rounded-full text-xs font-medium ${
                        result.success ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'
                      }`}>
                        {result.success 
                          ? (currentLanguage === 'np' ? 'тЬЕ рд╕рдлрд▓' : 'тЬЕ Success')
                          : (currentLanguage === 'np' ? 'тЭМ рдЕрд╕рдлрд▓' : 'тЭМ Failed')
                        }
                      </span>
                    </div>

                    {result.success ? (
                      <div className="space-y-2 text-sm">
                        <div className="grid grid-cols-2 gap-4">
                          <div>
                            <span className="font-medium text-gray-700">
                              {currentLanguage === 'np' ? 'рдкрддреНрддрд╛ рд▓рдЧрд╛рдЗрдПрдХреЛ рдлрд░реНрдореНрдпрд╛рдЯ:' : 'Detected Format:'}
                            </span>
                            <span className="ml-2 text-blue-600">{result.detectedFormat}</span>
                          </div>
                          <div>
                            <span className="font-medium text-gray-700">
                              {currentLanguage === 'np' ? 'рдкреНрд░рд╕рдВрд╕реНрдХрд░рдг рд╕рдордп:' : 'Processing Time:'}
                            </span>
                            <span className="ml-2 text-green-600">{result.processingTime}ms</span>
                          </div>
                        </div>

                        {result.stats && (
                          <div className="bg-white rounded p-3 mt-3">
                            <h5 className="font-medium text-gray-800 mb-2">
                              ЁЯУИ {currentLanguage === 'np' ? 'рддрдереНрдпрд╛рдЩреНрдХрд╣рд░реВ' : 'Statistics'}
                            </h5>
                            <div className="grid grid-cols-2 gap-3 text-xs">
                              <div>
                                <span className="text-gray-600">{currentLanguage === 'np' ? 'рд░рдЩрд╣рд░реВ:' : 'Colors:'}</span>
                                <span className="ml-2 font-medium">{result.stats.totalColors}</span>
                              </div>
                              <div>
                                <span className="text-gray-600">{currentLanguage === 'np' ? 'рд╕рд╛рдЗрдЬрд╣рд░реВ:' : 'Sizes:'}</span>
                                <span className="ml-2 font-medium">{result.stats.totalSizes}</span>
                              </div>
                              <div>
                                <span className="text-gray-600">{currentLanguage === 'np' ? 'рдХреБрд▓ рдЯреБрдХреНрд░рд╛:' : 'Total Pieces:'}</span>
                                <span className="ml-2 font-medium">{result.stats.totalPieces}</span>
                              </div>
                              <div>
                                <span className="text-gray-600">{currentLanguage === 'np' ? 'рдмрдиреНрдбрд▓рд╣рд░реВ:' : 'Bundles:'}</span>
                                <span className="ml-2 font-medium">{result.stats.estimatedBundles}</span>
                              </div>
                            </div>
                          </div>
                        )}

                        {result.validation.warnings.length > 0 && (
                          <div className="bg-yellow-50 border border-yellow-200 rounded p-2 mt-2">
                            <p className="text-yellow-700 text-xs">
                              тЪая╕П {currentLanguage === 'np' ? 'рдЪреЗрддрд╛рд╡рдиреА:' : 'Warnings:'} {result.validation.warnings.join(', ')}
                            </p>
                          </div>
                        )}

                        {/* Sample parsed data preview */}
                        {result.data && result.data.colors && result.data.colors.length > 0 && (
                          <div className="bg-white rounded p-3 mt-3">
                            <h5 className="font-medium text-gray-800 mb-2">
                              ЁЯОи {currentLanguage === 'np' ? 'рдкрд╛рд░реНрд╕ рдЧрд░рд┐рдПрдХреЛ рдбреЗрдЯрд╛ рдирдореВрдирд╛' : 'Parsed Data Sample'}
                            </h5>
                            <div className="text-xs space-y-1">
                              {result.data.colors.slice(0, 2).map((color, colorIndex) => (
                                <div key={colorIndex} className="flex items-center space-x-2">
                                  <span className="font-medium text-blue-600">{color.name}:</span>
                                  <span className="text-gray-600">
                                    {Object.entries(color.pieces).slice(0, 3).map(([size, pieces]) => 
                                      `${size}:${pieces}`
                                    ).join(', ')}
                                    {Object.keys(color.pieces).length > 3 && '...'}
                                  </span>
                                  <span className="text-purple-600">(Total: {color.total || Object.values(color.pieces).reduce((sum, p) => sum + p, 0)})</span>
                                </div>
                              ))}
                              {result.data.colors.length > 2 && (
                                <p className="text-gray-500">+ {result.data.colors.length - 2} more colors</p>
                              )}
                            </div>
                          </div>
                        )}
                      </div>
                    ) : (
                      <div className="text-red-600 text-sm">
                        <p className="font-medium">
                          {currentLanguage === 'np' ? 'рддреНрд░реБрдЯрд┐:' : 'Error:'}
                        </p>
                        <p className="mt-1">{result.error}</p>
                      </div>
                    )}
                  </div>
                ))}
              </div>

              {/* Overall Summary */}
              <div className="bg-gray-50 rounded-lg p-4 mt-6">
                <h4 className="font-semibold text-gray-800 mb-3">
                  ЁЯУЛ {currentLanguage === 'np' ? 'рд╕рдордЧреНрд░ рд╕рд╛рд░рд╛рдВрд╢' : 'Overall Summary'}
                </h4>
                <div className="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                  <div className="text-center">
                    <div className="text-2xl font-bold text-green-600">
                      {testResults.filter(r => r.success).length}
                    </div>
                    <div className="text-gray-600">{currentLanguage === 'np' ? 'рд╕рдлрд▓ рдкрд░реАрдХреНрд╖рдг' : 'Successful Tests'}</div>
                  </div>
                  <div className="text-center">
                    <div className="text-2xl font-bold text-red-600">
                      {testResults.filter(r => !r.success).length}
                    </div>
                    <div className="text-gray-600">{currentLanguage === 'np' ? 'рдЕрд╕рдлрд▓ рдкрд░реАрдХреНрд╖рдг' : 'Failed Tests'}</div>
                  </div>
                  <div className="text-center">
                    <div className="text-2xl font-bold text-blue-600">
                      {testResults.filter(r => r.success).reduce((sum, r) => sum + (r.stats?.totalPieces || 0), 0)}
                    </div>
                    <div className="text-gray-600">{currentLanguage === 'np' ? 'рдХреБрд▓ рдЯреБрдХреНрд░рд╛ рдкрд╛рд░реНрд╕ рднрдпреЛ' : 'Total Pieces Parsed'}</div>
                  </div>
                  <div className="text-center">
                    <div className="text-2xl font-bold text-purple-600">
                      {testResults.filter(r => r.success).reduce((avg, r) => avg + (r.processingTime || 0), 0) / Math.max(testResults.filter(r => r.success).length, 1)}ms
                    </div>
                    <div className="text-gray-600">{currentLanguage === 'np' ? 'рдФрд╕рдд рдкреНрд░рд╕рдВрд╕реНрдХрд░рдг рд╕рдордп' : 'Avg Processing Time'}</div>
                  </div>
                </div>
              </div>
            </div>
          )}
        </div>
      </div>
    </div>
  );
};

export default WIPDataTester;